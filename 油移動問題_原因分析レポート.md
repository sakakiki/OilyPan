# 油移動問題 原因分析レポート

## 問題の概要
W/Sキーで油が動かない（後にA/Dキーでも同様の問題が発生）現象について、根本原因を特定し修正を行った。

## 根本原因：座標系の次元変換における情報混乱

### 1. 問題の核心
**VelocityCalc.shader内での3D→2D→3D変換による座標軸の不整合**

### 2. 具体的な問題箇所

#### 修正前のデータフロー
```glsl
// C#側: 2Dデータ
_Gravity.x = panLocal.x  // パンX軸（左右傾き）
_Gravity.y = panLocal.z  // パンZ軸（前後傾き）

// シェーダー: 2D→3D変換
float3 G = float3(_Gravity.x, 0.0, _Gravity.y);
//             ↑X軸        ↑Y=0   ↑Z軸

// 重力投影計算（3D）
float3 g_tangent3 = G - N * dot(G, N);

// 3D→2D変換
float2 g_tangent = float2(g_tangent3.x, g_tangent3.z);
//                        ↑X軸           ↑Z軸

// 最終出力（2D）
return float4(v.x, v.y, 0.0, 1.0);  // テクスチャU,V方向
```

### 3. 問題が発生するメカニズム

#### 座標軸マッピングの混乱
- **段階1**: C#で `(panLocal.x, panLocal.z)` → `(_Gravity.x, _Gravity.y)`
- **段階2**: シェーダーで `(_Gravity.x, _Gravity.y)` → `(G.x, G.z)` ※G.y=0
- **段階3**: 投影後に `(g_tangent3.x, g_tangent3.z)` → `(g_tangent.x, g_tangent.y)`
- **段階4**: 最終的に `(v.x, v.y)` → テクスチャの `(U, V)` 方向

#### 致命的な不整合
1. **テクスチャ座標系の曖昧性**: UV座標とXYZ座標の対応が一貫していない
2. **中間次元変換**: 3D空間での法線投影計算が必要以上に複雑
3. **座標軸の取り違え**: 各段階で異なる軸の解釈が混在

### 4. 具体的な症状

#### 動作パターン
- **X軸方向（A/D）**: 偶然正しく動作（座標変換の結果が期待値と一致）
- **Y軸方向（W/S）**: 動作せず（座標変換で情報が失われる、または打ち消される）

#### 数学的な原因
重力ベクトルGと法線ベクトルNの投影計算において：
```glsl
g_tangent3 = G - N * dot(G, N)
```
法線Nの計算自体も座標系の不整合により正しくない方向を向いていたため、投影結果が物理的に意味のない値になっていた。

### 5. 修正アプローチ

#### 修正方針
**「3D変換を完全に排除し、すべて2Dテクスチャ座標系で一貫して計算」**

#### 修正後のデータフロー
```glsl
// C#側: 2Dデータ（変更なし）
_Gravity.x = panLocal.x
_Gravity.y = panLocal.z

// シェーダー: 2D計算のみ
float2 g_2d = float2(_Gravity.x, _Gravity.y);  // 直接2Dで使用

// 法線から表面傾きを2Dで計算
float2 surface_tilt = N.xy / max(N.z, 0.001);

// 2D投影計算
float2 g_tangent = g_2d - surface_tilt * dot(g_2d, surface_tilt) / max(dot(surface_tilt, surface_tilt), 0.001);

// 最終出力（座標系一貫）
return float4(v.x, v.y, 0.0, 1.0);
```

### 6. 修正結果

#### 改善点
1. **座標系の一貫性**: テクスチャUV ↔ パンXZ ↔ 入力A/D,W/S の対応が明確
2. **計算の簡潔性**: 不要な3D変換を排除
3. **物理的正確性**: 重力投影が数学的に正しく動作

#### 動作確認
- **A/Dキー**: 左右移動（符号調整済み）
- **W/Sキー**: 前後移動
- **ジャイロ**: デバイス傾きに対応

### 7. 学習事項

#### 設計上の教訓
1. **座標系の早期統一**: プロジェクト開始時に座標系の対応を明確に定義
2. **不要な次元変換の回避**: 2Dで済む計算を3Dで行わない
3. **段階的検証**: 各変換段階でのデバッグ出力による検証の重要性

#### デバッグ手法
1. **データフロー追跡**: 各段階での値の変化を可視化
2. **座標系図示**: 複数座標系の関係を図で明確化  
3. **段階的修正**: 一度に複数の変更を行わず、段階的に問題を切り分け

## 結論

問題の本質は「座標系の次元変換における情報の混乱と喪失」であった。3D→2D→3D変換により座標軸の対応が不明確になり、特定の軸での物理計算が正常に機能しなくなっていた。

修正により、座標系を2Dテクスチャ空間に統一し、すべての計算を一貫して行うことで問題を根本解決した。この修正アプローチは、同様の座標系変換問題の解決にも応用可能である。

---

## 追加修正：油移動速度の最適化

### 8. 速度向上の必要性

座標系問題の修正後、油の移動が正常に動作するようになったが、移動速度が遅すぎてリアルタイム性に欠ける問題が発生。ユーザビリティ向上のため、応答性と移動速度の大幅な向上が必要となった。

### 9. 速度関連パラメータの段階的調整

#### 第1段階：基本的な速度向上
```csharp
// 修正前（安全重視の設定）
velocityToParticleScale = 1.0f;    // 移動倍率
maxParticleSpeed = 0.5f;           // 上限速度
particleFriction = 1.5f;           // 摩擦
gravityScale = 0.5f;               // 重力スケール
velocitySmoothing = 0.15f;         // 応答性

// 第1段階修正後
velocityToParticleScale = 3.0f;    // 3倍の移動倍率
maxParticleSpeed = 2.0f;           // 4倍の上限速度
particleFriction = 0.8f;           // 摩擦を半減
gravityScale = 1.5f;               // 3倍の重力効果
velocitySmoothing = 0.25f;         // 応答性向上
```

#### 第2段階：さらなる高速化
```csharp
// 最終調整値
velocityToParticleScale = 6.0f;    // 6倍の移動倍率
maxParticleSpeed = 4.0f;           // 8倍の上限速度
particleFriction = 0.3f;           // 摩擦を大幅削減
gravityScale = 2.5f;               // 5倍の重力効果
velocitySmoothing = 0.4f;          // 最高応答性
velocitySampleInterval = 0.02f;    // 読み取り頻度向上
```

#### シェーダーパラメータの調整
```csharp
// 修正前
_kSlope = 0.6f;     // 勾配感度
_kGravity = 1.0f;   // 重力寄与
_maxVel = 0.6f;     // シェーダー上限

// 最終調整後
_kSlope = 2.5f;     // 4倍の勾配感度
_kGravity = 4.0f;   // 4倍の重力寄与
_maxVel = 4.0f;     // 7倍のシェーダー上限
```

### 10. 速度調整の効果分析

#### パフォーマンス向上指標
- **総合移動速度**: 初期値の約6-8倍に向上
- **入力応答性**: キー入力からの反応時間が大幅短縮
- **物理的リアリティ**: 低摩擦により自然な流動性を実現
- **ユーザビリティ**: リアルタイムでの直感的な操作が可能

#### 各パラメータの影響範囲

| パラメータ | 影響範囲 | 調整効果 |
|-----------|---------|---------|
| `velocityToParticleScale` | 全体的な移動速度 | 6倍 → 直接的な速度向上 |
| `maxParticleSpeed` | 速度上限 | 8倍 → 高速移動時の制限緩和 |
| `particleFriction` | 持続性 | 80%減 → 慣性による継続的な流れ |
| `gravityScale` | 傾き応答 | 5倍 → デバイス傾きへの敏感な反応 |
| `velocitySmoothing` | 応答性 | 2.7倍 → 入力変化への即座の対応 |
| `velocitySampleInterval` | 更新頻度 | 2.5倍 → より細かい時間間隔での更新 |

### 11. 最適化における設計判断

#### トレードオフの考慮
- **速度 vs 安定性**: 高速化により数値的不安定性のリスクが増加するが、ユーザビリティを優先
- **応答性 vs 滑らかさ**: より敏感な反応を優先し、過度の平滑化を避ける
- **リアリズム vs 操作性**: 物理的正確性よりもインタラクティブな体験を重視

#### 調整可能性の確保
Inspector上でリアルタイムに調整可能な設計を維持し、用途や好みに応じた微調整を可能にした。

### 12. 最終的な成果

座標系修正と速度最適化により：
1. **機能的完全性**: すべての軸（A/D, W/S）で正常動作
2. **直感的操作性**: 入力と視覚的反応の即座の対応
3. **物理的自然さ**: 低摩擦による流体らしい挙動
4. **スケーラビリティ**: 設定による幅広い用途への対応